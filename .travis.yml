# Use container-based infrastructure
dist: trusty

# Services
services:
  - postgresql
  - docker

addons:
  postgresql: "9.6"

env:
  global:
    - DJANGO_SETTINGS_MODULE=opentech.settings.production
    - DATABASE_URL=postgres://postgres@localhost/test_db
    - CFG_SECRET_KEY=iamnotsosecret
    - CFG_ALLOWED_HOSTS=localhost

before_script:
  # Create a database
  - psql -c 'create database test_db;' -U postgres

# Package installation
install:
  - docker build -t opentech:latest .
  - docker run opentech:latest pip install codecov

# Run the tests
script:
  # Run python code style checks
  - docker run opentech:latest flake8

  # Run system checks
  - |
    docker run -e DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE \
    -e DATABASE_URL=$DATABASE_URL \
    -e CFG_SECRET_KEY=$CFG_SECRET_KEY \
    -e CFG_ALLOWED_HOSTS=$CFG_ALLOWED_HOSTS \
    opentech:latest python manage.py check

  # Check for missing migrations
  - docker run opentech:latest python manage.py makemigrations --check --noinput --verbosity=0

  # Run tests
  - docker run opentech:latest coverage run --source='.' manage.py test .

after_success:
  codecov

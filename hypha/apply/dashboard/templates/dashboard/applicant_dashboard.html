{% extends "base-apply.html" %}
{% load render_table from django_tables2 %}
{% load i18n static wagtailcore_tags workflow_tags heroicons statusbar_tags dashboard_statusbar_tags apply_tags invoice_tools %}

{% block title %}{% trans "Dashboard" %}{% endblock %}

{% block content_wrapper %}
    <main class="wrapper wrapper--large wrapper--main bg-light-grey" id="main">
        {% block content %}
            <div class="admin-bar">
                <div class="admin-bar__inner wrapper--applicant-dashboard">
                    <div class="my-auto">
                        <h1 class="heading heading--no-margin font-bold">{% trans "My dashboard" %}</h1>
                        <p class="m-0">{% trans "An overview of active and past submissions and projects" %}</p>
                    </div>
                    <div class="wrapper wrapper--cta-box flex items-center">
                        <div class="flex-1">
                            <h3 class="heading heading--no-margin font-bold">{% trans "Submit a new application" %}</h3>
                            <p class="text-base m-0">{% trans "Apply now for our open rounds" %}</p>
                        </div>
                        <div>
                            <a class="button button--blue-white" href="{% pageurl APPLY_SITE.root_page %}" class="button">{% trans "Apply" %}</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="wrapper wrapper--large wrapper--inner-space-medium">
                {% if my_tasks.count %}
                    <div class="w-8/12 m-auto mb-10">
                        <h2 class="text-center font-light">{% trans "My tasks" %}</h2>
                        {% for project in my_tasks.tasks.projects_waiting_for_contract %}
                            <div class="bg-white p-1 flex mb-1 items-center">
                                <svg class="icon icon--dashboard-tasks"><use xlink:href="#dashboard-contract"></use></svg>
                                <p class="flex-1">{% trans "Project " %}'<a href="{{ project.get_absolute_url }}">{{ project.title }}</a>'{% trans " is waiting for contract" %}</p>
                                <a class="button button-primary m-2" href="{{ project.get_absolute_url }}">View</a>
                            </div>
                        {% endfor %}
                        {% for project in my_tasks.tasks.projects_waiting_for_contract_documents %}
                            <div class="bg-white p-1 flex mb-1 items-center">
                                <svg class="icon icon--dashboard-tasks"><use xlink:href="#dashboard-document"></use></svg>
                                <p class="flex-1">{% trans "Project " %}'<a href="{{ project.get_absolute_url }}">{{ project.title }}</a>'{% trans " is waiting for contract document submissions" %}</p>
                                <a class="button button-primary m-2" href="{{ project.get_absolute_url }}">View</a>
                            </div>
                        {% endfor %}
                        {% for invoice in my_tasks.tasks.invoices_require_updates %}
                            <div class="bg-white p-1 flex mb-1 items-center">
                                <svg class="icon icon--dashboard-tasks"><use xlink:href="#dashboard-invoice"></use></svg>
                                <p class="flex-1">{% trans "Changes requested for invoice " %}'<a href="{{ invoice.get_absolute_url }}">{{ invoice.invoice_number }}</a>'</p>
                                <a class="button button-primary m-2" href="{{ invoice.get_absolute_url }}">View</a>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                <div class="mb-10">
                    <div class="flex">
                        <h2 class="font-light flex-1">{% trans "My active submissions" %}</h2>
                        <p class="font-bold"><a href="{% url 'apply:submissions:overview' %}" target="_blank">{% trans "View all submissions" %}</a></p>
                    </div>
                    {% for submission in my_active_submissions %}
                        <div class="wrapper wrapper--status-bar-outer">
                            <div class="wrapper wrapper--status-bar-inner">
                                <div class="mt-5 ml-4">
                                    <h4 class="heading mb-2 font-bold"><a class="link link--underlined" href="{% url 'funds:submissions:detail' submission.id %}">{{ submission.title }}</a></h4>
                                    <p class="m-0 text-gray-400">{% trans "Submitted on " %} {{ submission.submit_time.date }} {% trans "by" %} {{ submission.user.get_full_name }}</p>
                                </div>
                                {% status_bar submission.workflow submission.phase request.user css_class="status-bar--small" %}
                            </div>
                            {% if request.user|has_edit_perm:submission %}
                                <a class="button button--primary ml-4" href="{% url 'funds:submissions:edit' submission.id %}">
                                    {% if submission.status == 'draft_proposal' %}
                                        {% trans "Start your" %} {{ submission.stage }} {% trans "application" %}
                                    {% else %}
                                        {% trans "Edit" %}
                                    {% endif %}
                                </a>
                            {% endif %}
                        </div>
                    {% empty %}
                        {% trans "No active submissions" %}
                    {% endfor %}
                </div>
                <div class="mb-10">
                    <div class="flex">
                        <h2 class="font-light flex-1">{% trans "My active projects" %}</h2>
                        <p class="font-bold"><a href="{% url 'apply:projects:overview' %}" target="_blank">{% trans "View all projects" %}</a></p>
                    </div>
                    {% for project in active_projects.data %}
                        <div class="wrapper wrapper--status-bar-outer">
                            <div class="wrapper wrapper--status-bar-inner">
                                <div class="mt-5 ml-4">
                                    <h4 class="heading mb-2 font-bold"><a class="link link--underlined" href="{% url 'apply:projects:detail' project.id %}">{{ project.title }}</a></h4>
                                    <p class="m-0 text-gray-400">{% trans "Project start date: " %} {{ project.created_at.date }}</p>
                                </div>
                                {% project_status_bar project.status request.user css_class="status-bar--small" %}
                            </div>
                        </div>
                    {% empty %}
                        {% trans "No active projects" %}
                    {% endfor %}
                </div>

                <div class="mb-10">
                    <div class="flex">
                        <h2 class="font-light flex-1">{% trans "My active invoices" %}</h2>
                        <p class="font-bold"><a href="{% url 'apply:projects:invoices' %}" target="_blank">{% trans "View all invoices" %}</a></p>
                    </div>
                    {% for invoice in active_invoices.data %}
                        <div class="wrapper wrapper--status-bar-outer">
                            <div class="wrapper wrapper--status-bar-inner pl-4 pr-4">
                                <div class="max-w-[33%] w-full text-left my-auto">
                                    <h4 class="heading heading--no-margin font-bold"><a class="link link--underlined" href="{{ invoice.get_absolute_url }}">
                                        {% if invoice.invoice_number %}{{ invoice.invoice_number }}{% else %}{{ invoice.vendor_document_number }}{% endif %}
                                    </a></h4>
                                    <p class="m-0 text-gray-400">{% trans "Date added: " %} {{ invoice.requested_at }}</p>
                                </div>
                                <div class="max-w-[33%] w-full text-center my-auto">
                                    <p class="text-2xl">{% if invoice.invoice_amount %}{{ invoice.invoice_amount | format_number_as_currency }}{% else %}-{% endif %}</p>
                                </div>
                                <div class="max-w-[33%] w-full flex my-auto">
                                    {% display_invoice_status_for_user request.user invoice as invoice_status %}
                                    <div class="w-full flex-1"></div>
                                    <div class="max-w-fit w-full text-right">
                                        <p class="bg-{{ invoice.get_status_display|invoice_status_colour }}-100 text-base py-2 px-3 text-{{ invoice.get_status_display|invoice_status_colour }}-600">{{ invoice_status }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        {% trans "No active invoices" %}
                    {% endfor %}
                </div>
            </div>

        {% endblock %}
{% endblock %}
</main>

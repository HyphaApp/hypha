{% extends "base-apply.html" %}
{% load i18n static nh3_tags %}
{% block title %}{% if object %}{% trans "Edit a Determination" %} {% if object.is_draft %}{% trans "draft" %}{% endif %}{% else %}{% trans "Create a Determination" %}{% endif %}{% endblock %}
{% block content %}

    {% adminbar %}
        {% slot header %}{% if object %}{% trans "Update Determination draft" %}{% else %}{% trans "Create Determination" %}{% endif %}{% endslot %}
        {% slot sub_heading %}{% if submission %}{% trans "For" %} <a class="text-blue-300 hover:underline" href="{% url "funds:submissions:detail" submission.id %}">{{ submission.title_text_display }}</a>{% endif %}{% endslot %}
    {% endadminbar %}

    {% block form %}
        <section class="my-8 flex"
                 x-data="{ submissionVisible: false }"
        >
            {% include "forms/includes/form_errors.html" with form=form %}
            {% block determination_information %}
            {% endblock %}
            <form class="form max-w-3xl"
                  action="" method="post"
                  x-data="{ isFormSubmitting: false }"
                  x-on:submit="isFormSubmitting = true"
                  x-bind:style="submissionVisible ? 'flex-basis: 50%' : 'flex-basis: 100%'">
                {{ form.media }}
                {% csrf_token %}
                {% for hidden in form.hidden_fields %}
                    {{ hidden }}
                {% endfor %}
                {% for field in form.visible_fields %}
                {# to be replaced with better logic when/if we use stream form #}
                    {% ifchanged field.field.group %}
                        {% for key, value in form.titles.items %}
                            {% if key == field.field.group %}
                                <h2>{{ value }}</h2>
                            {% endif %}
                        {% endfor %}
                    {% endifchanged %}
                    {% if field.field %}
                        {% include "forms/includes/field.html" %}
                    {% else %}
                        {{ field.block }}
                    {% endif %}
                {% endfor %}
                {% block form_buttons %}
                    <div class="form__group">
                        {% if form.draft_button_name %}
                            <button class="button button--submit button--white" type="submit" name="{{ form.draft_button_name }}">{% trans "Save draft" %}</button>
                        {% endif %}
                        <button class="button button--submit button--primary" :disabled="isFormSubmitting" type="submit" name="submit">{% trans "Submit" %}</button>
                    </div>
                {% endblock %}
            </form>
            {% for type, message in message_templates.items %}
                <div class="is-hidden" data-type="{{ type }}" id="determination-message-{{ type }}">
                    {{ message }}
                </div>
            {% endfor %}
            <aside id="submission-flyout"
                   style="margin: 1rem"
                   x-bind:style="submissionVisible ? 'flex-basis: 50%; margin: 1rem' : 'flex-basis: 2rem; margin: 0'">
                <button class="button button--primary"
                        hx-get="{% url 'funds:submissions:partial-answers' submission.id %}"
                        hx-trigger="click once"
                        hx-swap="innerHTML"
                        hx-target="#submission-summary"
                        @click="submissionVisible = ! submissionVisible">
                    {% trans "View/Hide Submission" %}
                </button>
                <section id="submission-summary" x-bind:style="submissionVisible ? 'display: block' : 'display: none'">
                </section>
            </aside>
    {% endblock %}
    </section>
{% endblock %}

{% block extra_js %}
    {{ field_blocks_ids|json_script:"block-ids" }}
    <script src="{% static 'js/determination-template.js' %}"></script>
{% endblock %}

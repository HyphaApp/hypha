{% load i18n static %}
<form
    class="form"
    id="reviewer_form"
    method="POST"
    hx-post="{{ request.path }}"
>
    <h2 class="px-4 py-2 text-white rounded-t bg-dark-blue">
        {% trans "Update reviewers" %}
    </h2>

    {% csrf_token %}
    {{ form.media }}
    {% for hidden in form.hidden_fields %}
        {{ hidden }}
    {% endfor %}

    <fieldset class="px-4">
        {% if form.errors %}
            {% for field in form %}
                {% for error in field.errors %}
                    <div class="alert alert-danger">
                        <strong>{{ error|escape }}</strong>
                    </div>
                {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
                <div class="alert alert-danger">
                    <strong>{{ error|escape }}</strong>
                </div>
            {% endfor %}
        {% endif %}
        {% for field in form.visible_fields %}
            {% if field.name == "external_reviewers" and not show_external_reviewers %}
            {% comment %} skip for external reviewer if not allowed {% endcomment %}
            {% else %}
                <fieldset class="mt-3">
                    <label for="{{ field.id_for_label }}">
                        {{ field.label }}
                    </label>
                    <div class="mt-2">
                        {{ field }}
                    </div>
                </fieldset>
            {% endif %}
        {% endfor %}
        <button
            class="mt-6 mb-3 button button--primary"
            type="submit"
        >
            {% trans "Update" %}
        </button>
    </fieldset>
</form>

<script type="module">
    {% comment %} Do this here as the select elements for different roles are dynamically generated. {% endcomment %}
    import Choices from "{% static 'js/esm/choices.js-10-2-0.js' %}";

    const selectElements = document.querySelectorAll('#reviewer_form select');

    // add choices to all select elements
    selectElements.forEach((selectElement) => {
        new Choices(selectElement, {
            removeItemButton: true,
            allowHTML: true,
        });
    });

    document.addEventListener('htmx:afterRequest', function (event) {
        if (event.detail.requestConfig.verb === 'post' && event.detail.successful) {
            document.dispatchEvent(new CustomEvent('htmx:reviewersUpdated'));
        }
    });
</script>

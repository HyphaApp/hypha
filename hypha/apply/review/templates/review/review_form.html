{% extends "base-apply.html" %}
{% load i18n static %}
{% block title %}{{ title }}{% endblock %}

{% block alpine_scripts %}
    {{ block.super }}
    <script defer src="{% static 'js/behaviours/review-score.js' %}"></script>
{% endblock %}

{% block content %}

    {% adminbar %}
        {% slot header %}{{ title }}{% endslot %}
        {% slot sub_heading %}
            {% trans "For" %} <a class="text-blue-300 hover:underline" href="{% url "funds:submissions:detail" submission.id %}">{{ submission.title }}</a>
        {% endslot %}
        {% slot buttons %}
            <button
                class="tab__item ms-auto block pb-4"
                x-data
                @click="showSubmission = !showSubmission"
            >
                <span x-show="!showSubmission">{% trans "Show application" %}</span>
                <span x-show="showSubmission">{% trans "Hide application" %}</span>
            </button>
            </a>
        {% endslot %}
    {% endadminbar %}

    {% include "forms/includes/form_errors.html" with form=form %}

    <section class="my-8 flex justify-between relative" x-data="reviewScore">
        <div class="absolute h-full right-0 top-0 hidden lg:block">
            <div
                class="bg-arsenic text-white font-semibold inline-block px-3 py-1.5 mt-1 text-center sticky top-1 float-end"
                x-clock
                x-show="showScore"
            >
                {% trans "Score:" %} <span x-text="totalScore">-</span>
            </div>
        </div>
        {% if not has_submitted_review %}
            <form id="review-form-edit" class="form form--scoreable max-w-3xl flex-1" action="" method="post">
                {{ form.media }}
                {% csrf_token %}

                {% for hidden in form.hidden_fields %}
                    {{ hidden }}
                {% endfor %}

                {% for field in form.visible_fields %}
                    {# to be replaced with better logic when we use stream form #}
                    {% ifchanged field.field.group %}
                        {% for key, value in form.titles.items %}
                            {% if key == field.field.group %}
                                <h2>{{ value }}</h2>
                            {% endif %}
                        {% endfor %}
                    {% endifchanged %}

                    {% if field.field %}
                        {% include "forms/includes/field.html" %}
                    {% else %}
                        {{ field.block }}
                    {% endif %}
                {% endfor %}

                <div class="flex gap-4 flex-wrap items-center">
                    {% if not object.id or object.is_draft %}
                        <button class="button button--white" type="submit" name="{{ form.draft_button_name }}" formnovalidate>
                            {% trans "Save draft" %}
                        </button>
                    {% endif %}
                    <button class="button button--primary min-w-48" type="submit" name="submit">
                        {% trans "Submit" %}
                    </button>
                    <div class="text-fg-muted" x-clock x-show="showScore">
                        {% trans "Total Score:" %} <span x-text="totalScore"></span>
                    </div>
                </div>

            </form>
            <aside :class="showSubmission ? 'flex-1 ps-4' : ''">
                <section
                    class="p-4 overflow-y-auto bg-white shadow-xl max-h-screen"
                    x-show="showSubmission"
                    x-transition:enter="transition ease-out duration-250"
                    x-transition:enter-start="transform opacity-0 translate-x-full"
                    x-transition:enter-end="transform opacity-100 translate-x-0"
                    x-transition:leave="transition ease-in duration-150"
                    x-transition:leave-start="transform opacity-100 translate-x-0"
                    x-transition:leave-end="transform opacity-0 translate-x-full"
                    hx-get="{% url 'funds:submissions:partial-answers' submission.id %}"
                    hx-trigger="intersect once"
                >
                    <p>{% trans "Loadingâ€¦" %}</p>
                </section>
            </aside>
        {% else %}
            <p>{% trans "You have already posted a review for this submission" %}</p>
        {% endif %}
    </section>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/review-form-actions.js' %}"></script>
{% endblock %}

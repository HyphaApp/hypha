{% load i18n util_tags heroicons %}

{% with widget_type=field|widget_type field_type=field|field_type %}
    <fieldset
        class="fieldset h-form__group {{ field.id_for_label }} form__group--{{ widget_type }} {% if widget_type == 'hidden_input' %}hidden{% endif %} {% if widget_type == 'checkbox_input' %} form__group--checkbox{% endif %}{% if widget_type == 'clearable_file_input' or widget_type == 'multi_file_input' or widget_type == 'single_file_field_widget' or widget_type == 'multi_file_field_widget' %} form__group--file{% endif %}{% if field.help_text %} flex-wrap{% endif %}{% if field.errors %} form__error{% endif %}{% if field.field.group_number > 1 %} field-group field-group-{{ field.field.group_number }}{% endif %}{% if field.field.grouper_for %} form-fields-grouper{% endif %}{% if widget_type == 'address_widget' %}bg-base-200/30 border-base-300 rounded-box w-sm border p-4{% endif %}"
        {% if field.field.grouper_for %}
            data-grouper-for="{{ field.field.grouper_for }}"
            data-toggle-on="{{ field.field.choices.0.0 }}"
            data-toggle-off="{{ field.field.choices.1.0 }}"
        {% endif %}
        {% if field.field.group_number > 1 %}
            data-hidden="{% if not show_all_group_fields and not field.field.visible %}true{% else %}false{% endif %}"
            data-required="{{ field.field.required_when_visible }}"
        {% endif %}
        {% if field.field.word_limit %}
            data-word-limit="{{ field.field.word_limit }}"
        {% endif %}
        {# fmt:off #}
        {% if widget_type == 'text_input' and field.field.max_length %}
            x-data="
             {
                curlength: 0,
                maxlength: 0,
                get visible() {
                    return this.curlength >= this.maxlength * 0.8;
                },
                init() {
                    const input = this.$el.querySelector('input');
                    this.maxlength = input.maxLength;
                    this.curlength = input.value.length;
                    input.addEventListener('input', (e) => {
                        this.curlength = e.target.value.length;
                    });
                }
            }"
        {% endif %}
        {# fmt:on #}
    >
        {% if widget_type == 'clearable_file_input' or widget_type == 'multi_file_input' or widget_type == 'single_file_field_widget' or widget_type == 'multi_file_field_widget'%}
            <span class="form__question form__file-label">
                {{ field.label }}
                {% if field.field.required %}
                    <span class="form__required">*</span>
                {% endif %}
            </span>
            <legend
                for="{{ field.id_for_label }}"
                class="fieldset-legend h-form__question form__question--{{ field_type }} h-widget-{{ widget_type }}"
                {% if field.field.required %}required{% endif %}
            >
                <span class="btn btn-secondary">
                    {% heroicon_mini "arrow-up-tray" class="w-4 h-4" aria_hidden="true" %}
                    {% trans "Upload" %}
                </span>
            </legend>
        {% elif widget_type == 'checkbox_select_multiple' or widget_type == 'radio_select' %}
            <fieldset class="fieldset">
                <legend class="fieldset-legend h-form__question--{{ field_type }} h-widget-{{ widget_type }}"
                        {% if field.field.required %}required{% endif %}
                >
                    {{ field.label }}
                    {% if field.field.required %}
                        <span class="form__required">*</span>
                    {% endif %}
                </legend>
        {% elif widget_type == 'checkbox_input' %}
            <label class="mt-2 text-sm label">
                {{ field }} {{ field.label }}
                {% if field.field.required %}
                    <span class="form__required">*</span>
                {% endif %}
            </label>
        {% else %}
            {% if not field.is_hidden and widget_type != 'checkbox_input' %}
                <legend
                    for="{{ field.id_for_label }}"
                    class="fieldset-legend h-form__question h-form__question--{{ field_type }} h-widget-{{ widget_type }} {{ label_classes }}"
                    {% if field.field.required %}required{% endif %}
                >
                    <span>{{ field.label }}</span>
                    {% if field.field.required %}
                        <span class="form__required">*</span>
                    {% endif %}
                </legend>
            {% endif %}
        {% endif %}

        {% if not field.is_hidden %}
            {% if widget_type == 'date_input' or widget_type == 'date_time_input' %}
                <div class="{{ widget_type }}">
            {% endif %}

            {% if widget_type != "checkbox_input" %}
                {{ field }}
            {% endif %}

            {% if field.errors %}
                <p class="form__error-text text-error-content bg-error">
                    {{ field.errors.as_text|linebreaksbr }}
                </p>
            {% endif %}

            {% if widget_type == 'clearable_file_input' or widget_type == 'multi_file_input' %}
                <output class="form__file-list"></output>
            {% endif %}

            {% if widget_type == 'date_input' or widget_type == 'date_time_input' %}
                </div>
            {% endif %}
        {% else %}
            {{ field }}
        {% endif %}

        <div class="flex gap-2 justify-between label">
            {% if field.help_text %}
                <label class="whitespace-normal">{{ field.help_text }}</label>
            {% endif %}
            {% if widget_type == 'text_input' and field.field.max_length %}
                <div x-cloak x-show="visible" x-transition>
                    <span x-text="curlength"></span>/<span x-text="maxlength"></span>
                </div>
            {% endif %}
        </div>

        {% if widget_type == 'checkbox_select_multiple' or widget_type == 'radio_select' %}
            </fieldset>
        {% endif %}
    </fieldset>
{% endwith %}

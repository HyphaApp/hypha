{% extends "base-apply.html" %}
{% load i18n wagtailcore_tags heroicons %}

{% block title %}{% trans "Log in" %}{% endblock %}
{% block body_class %}bg-base-100{% endblock %}

{% block content %}
    <div class="my-5 max-w-2xl">

        <section>
            <div class="px-4 pt-4">
                {% if wizard.steps.current == 'token' %}
                    {% if device.method == 'call' %}
                        <p>{% blocktrans trimmed %}We are calling your phone right now, please enter the
                            digits you hear.{% endblocktrans %}</p>
                    {% elif device.method == 'sms' %}
                        <p>{% blocktrans trimmed %}We sent you a text message, please enter the tokens we
                            sent.{% endblocktrans %}</p>
                    {% else %}
                        <h2 class="text-2xl">{% trans "Two factor verification" %}</h2>
                        <p>{% blocktrans trimmed %}Please enter the 6-digit verification code generated by your Authenticator App.{% endblocktrans %}</p>
                    {% endif %}
                {% elif wizard.steps.current == 'backup' %}
                    <h2 class="text-2xl">{% trans "Two factor verification" %}</h2>
                    <p>
                        {% blocktrans trimmed %}Please enter one of the backup codes to log in to your account.{% endblocktrans %}
                    </p>
                    <p class="mb-4 text-sm text-fg-muted">
                        {% blocktrans trimmed %}Those codes were generated for you during 2FA setup to print or keep safe in a password manager.{% endblocktrans %}
                    </p>
                {% endif %}

                <form class="form form--user-login" method="post">
                    {% csrf_token %}
                    {{ wizard.management_form }}

                    {% if wizard.steps.current == 'auth' %}

                        <style>
                            .id_auth-password {
                                margin-bottom: 0.25rem;
                            }
                        </style>

                        <h2 class="text-2xl">{% blocktrans %}Log in to {{ ORG_SHORT_NAME }}{% endblocktrans %}</h2>
                        {% for field in form %}
                            <div class="relative max-w-sm">
                                {% include "forms/includes/field.html" %}
                                {% if field.auto_id == "id_auth-password" %}
                                    <div class="text-end">
                                        <a
                                            class="link link-secondary link-hover"
                                            href="{% url 'users:password_reset' %}{% if redirect_url %}?next={{ redirect_url }}{% endif %}"
                                            hx-boost="true"
                                        >
                                            {% trans "Forgot your password?" %}
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}

                        {% if settings.users.AuthSettings.extra_text %}
                            <div class="p-4 mb-6 rounded-xs prose prose-sm bg-base-200">
                                {{ settings.users.AuthSettings.extra_text|richtext }}
                            </div>
                        {% endif %}

                        <div class="mt-4">
                            <button class="btn btn-primary btn-block sm:btn-wide" type="submit">
                                {% trans "Log in" %}
                            </button>
                        </div>

                        <div class="flex relative justify-center items-center mb-4 min-[465px]:justify-start">
                            <hr class="inline my-6 w-32 h-px bg-gray-300 border-0">
                            <span class="px-3 font-medium text-fg-muted">{% trans "or" %}</span>
                            <hr class="inline my-6 w-32 h-px bg-gray-300 border-0">
                        </div>

                        <section class="space-y-0.5">
                            {% if GOOGLE_OAUTH2 %}
                                {% include "includes/org_login_button.html" %}
                            {% endif %}
                            {% include "includes/passwordless_login_button.html" %}
                            </section

                    {% else %}

                        <div class="form__group">
                            {{ wizard.form }}
                        </div>

                        {# hidden submit button to enable [enter] key #}
                        <div class="sr-only"><input type="submit" value=""/></div>

                        {% if other_devices %}
                            <p>{% trans "Or, alternatively, use one of your backup phones:" %}</p>
                            <p>
                                {% for other in other_devices %}
                                    <button name="challenge_device" value="{{ other.persistent_id }}"
                                            class="btn btn-default btn-block" type="submit">
                                        {{ other.generate_challenge_button_title }}
                                    </button>
                                {% endfor %}</p>
                        {% endif %}

                        <div class="wrapper">
                            {% include "two_factor/_wizard_actions.html" %}
                        </div>

                        {% if backup_tokens %}
                            <p>{% trans "As a last resort, you can use a backup codes: " %}
                                <button
                                    name="wizard_goto_step"
                                    type="submit"
                                    value="backup"
                                    aria-label="Click here to use a backup code"
                                    class="inline font-bold transition-opacity hover:opacity-70 text-dark-blue"
                                >
                                    {% trans "Use a Backup Code" %}
                                </button>
                            </p>
                        {% endif %}
                    {% endif %}
                </form>
            </div>
        </section>
    </div>

    {# Fix copy of dynamic fields label #}
    <script>
        var labelOtpToken = document.querySelector("label[for=id_token-otp_token]");
        if(labelOtpToken){
            labelOtpToken.textContent = "{% trans 'Verification Code' %}: ";
        }
        var labelBackupOTPToken = document.querySelector("label[for=id_backup-otp_token]");
        if(labelBackupOTPToken){
            labelBackupOTPToken.textContent = "{% trans 'Backup Code' %}: ";
        }
    </script>


{% endblock %}

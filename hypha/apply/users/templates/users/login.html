{% extends 'base.html' %}
{% load i18n wagtailcore_tags %}

{% block header_modifier %}header--light-bg{% endblock %}
{% block page_title %}{% trans "Login" %}{% endblock %}
{% block title %}{% trans "Login" %}{% endblock %}

{% block content %}
  <div class="wrapper wrapper--small">
    {% if wizard.steps.current == 'token' %}
        {% if device.method == 'call' %}
            <p>{% blocktrans trimmed %}We are calling your phone right now, please enter the
                digits you hear.{% endblocktrans %}</p>
        {% elif device.method == 'sms' %}
            <p>{% blocktrans trimmed %}We sent you a text message, please enter the tokens we
                sent.{% endblocktrans %}</p>
        {% else %}
            <p>{% blocktrans trimmed %}Please enter the 6-digit verification code generated by your Authenticator App.{% endblocktrans %}</p>
        {% endif %}
    {% elif wizard.steps.current == 'backup' %}
        <p>{% blocktrans trimmed %}Please enter one of the backup codes to login to your account.
            Those codes were generated for you during 2FA setup to print or keep safe in a password manager.{% endblocktrans %}</p>
    {% endif %}

    <form class="form form--with-p-tags form--user-login" method="post">
      {% csrf_token %}
      {{ wizard.management_form }}

      {% if wizard.steps.current == 'auth' %}
        {% for field in form %}
            {% include "forms/includes/field.html" %}
            {% if field.name == 'password' and not is_public_site %}
                <div class="password-reset"><a class="link" href="{% url 'users:password_reset' %}">{% trans "Forgot your password?" %}</a></div>
            {% endif %}
        {% endfor %}
        {{ form.extra_text|richtext }}
        <button class="link link--button link--button-wide link--button-secondary" type="submit">{% trans "Login" %}</button>
        {% if not is_public_site %}
            <p><a class="link link--small" href="{% url 'users:password_reset' %}">{% trans "Forgot your password?" %}</a></p>
        {% endif %}
        <p><a class="link link--small" href="{% url 'users_public:register' %}">{% trans "Dont't have an account? Register here to submit applications" %}</a></p>
        <button class="link link--button-secondary" type="submit">{% trans "Login" %}</button>
      {% else %}
        {{ wizard.form }}

        {# hidden submit button to enable [enter] key #}
        <div style="margin-left: -9999px"><input type="submit" value=""/></div>

        {% if other_devices %}
            <p>{% trans "Or, alternatively, use one of your backup phones:" %}</p>
            <p>
                {% for other in other_devices %}
                <button name="challenge_device" value="{{ other.persistent_id }}"
                                class="btn btn-default btn-block" type="submit">
                    {{ other.generate_challenge_button_title }}
                </button>
            {% endfor %}</p>
        {% endif %}
        {% if backup_tokens %}
            <p>{% trans "As a last resort, you can use a backup codes:" %}
                <button name="wizard_goto_step" type="submit" value="backup"
                                class="link link--button link--button-white link--button-white--narrow">{% trans "Use Backup Code" %}</button>
            </p>
        {% endif %}

        <div class="wrapper wrapper--inner-space-large">
            {% include "two_factor/_wizard_actions.html" %}
        </div>
      {% endif %}
    </form>

    {% if wizard.steps.current == 'auth' and GOOGLE_OAUTH2 %}
        <div class="wrapper wrapper--bottom-space">
          <a class="link link--button link--button-tertiary" href="{% url "social:begin" "google-oauth2" %}{% if next %}?next={{ next }}{% endif %}">{% blocktrans %}Log in with your {{ ORG_SHORT_NAME }} email{% endblocktrans %}</a>
        </div>
    {% endif %}
    <script>
    {# Fix copy of dynamic fields label #}
    var labelOtpToken = document.querySelector("label[for=id_token-otp_token]");
    if(labelOtpToken){
        labelOtpToken.textContent = "{% trans 'Verification Code' %}: ";
    }
    var labelBackupOTPToken = document.querySelector("label[for=id_backup-otp_token]");
    if(labelBackupOTPToken){
        labelBackupOTPToken.textContent = "{% trans 'Backup Code' %}: ";
    }
    </script>
  </div>
{% endblock %}
